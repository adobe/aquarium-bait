---
- name: Delete hibernate sleepimage file
  file:
    state: absent
    path: /var/vm/sleepimage
  become: true

- name: Delete bash history
  file:
    state: absent
    path: /Users/{{ ansible_user }}/{{ item }}
  loop:
    - .bash_history
    - .bash_sessions

- name: Empty trash
  ignore_errors: true
  file:
    state: absent
    path: /Users/{{ ansible_user }}/.Trash

- name: Clean caches & tmp dirs
  block:
    - name: Check caches & temp files
      find:
        file_type: any
        paths:
          - /Library/Caches
          - /Users/{{ ansible_user }}/Library/Caches
          - /tmp
      register: reg_caches

    - name: Clean found items
      when: reg_caches.matched > 0
      file:
        path: "{{ item.path }}"
        state: absent
      with_items: "{{ reg_caches.files }}"
      # Caches cleaning on MacOS 11.6 is harder with SIP activated so some folders can't be
      # accessible, so ignoring them in case they producing an error
      ignore_errors: "{{ item.path.endswith('/com.apple.HomeKit') or item.path.endswith('/CloudKit') }}"
      become: true

- name: Fill free space with zeroes
  shell: cat /dev/zero > wipefile; rm -f wipefile
  changed_when: false
  become: true
