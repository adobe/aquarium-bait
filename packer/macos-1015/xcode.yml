---
min_packer_version: 1.6.6
variables:
  vm_name: macos-1015-xcode
  out_full_path: "{{ env `PWD` }}/out"
  vmx_full_path: "{{ user `out_full_path` }}/macos-1015/macos-1015.vmx"
  username: packer
  password: packer

builders:
  - type: vmware-vmx
    vm_name: "{{ user `vm_name` }}"
    display_name: "{{ user `vm_name` }}"
    source_path: "{{ user `vmx_full_path` }}"
    linked: true # Use base image to simplify the data transfer
    attach_snapshot: original
    output_directory: "{{ user `out_full_path` }}/{{ user `vm_name` }}"
    #headless: true TODO: enable it
    boot_wait: 30s
    shutdown_command: "echo '{{ user `username` }}' | sudo -S shutdown -h now"
    ssh_username: "{{ user `username` }}"
    ssh_password: "{{ user `password` }}"
    ssh_timeout: 10s
    ssh_read_write_timeout: 10s
    ssh_wait_timeout: 2m

provisioners:
  - type: ansible
    command: ./run_ansible.sh
    user: "{{ user `username` }}"
    playbook_file: playbooks/xcode_image.yml
    extra_arguments:
      - --extra-vars
      - ansible_sudo_pass={{ user `password` }}

post-processors:
  - type: shell-local # Use relative path in vmx
    command: "empty"
    execute_command:
      - sed
      - -i
      - s|{{ user `out_full_path` }}|..|g
      - "{{ user `out_full_path` }}/{{ user `vm_name` }}/{{ user `vm_name` }}.vmx"

  - type: shell-local # Create snapshot
    command: "empty"
    execute_command:
      - vmrun
      - snapshot
      - "{{ user `out_full_path` }}/{{ user `vm_name` }}/{{ user `vm_name` }}.vmx"
      - original

  - type: shell-local # Need to relace with the actual path on target machine
    command: "empty"
    execute_command:
      - sed
      - -i
      - s|{{ user `out_full_path` }}|<REPLACE_PARENT_VM_FULL_PATH>|
      - "{{ user `out_full_path` }}/{{ user `vm_name` }}/{{ user `vm_name` }}.vmsd"
