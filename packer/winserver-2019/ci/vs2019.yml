---
min_packer_version: 1.7.9
variables:
  vm_name: winserver-2019-ci-vs2019
  out_full_path: "{{ env `PWD` }}/out"
  vmx_full_path: "{{ user `out_full_path` }}/winserver-2019-ci/winserver-2019-ci.vmx"
  aquarium_bait_stage: NONE # Used to find out the disk clone index
  aquarium_bait_proxy_port: null # Local proxy port to bypass VPN routing
  username: packer
  password: packer

builders:
  - type: vmware-vmx
    vm_name: "{{ user `vm_name` }}"
    display_name: "{{ user `vm_name` }}"
    source_path: "{{ user `vmx_full_path` }}"
    linked: true # Use base image to simplify the data transfer
    attach_snapshot: original
    output_directory: "{{ user `out_full_path` }}/{{ user `vm_name` }}"
    headless: true
    boot_wait: 15s
    shutdown_command: shutdown /s /t 5 /f /d p:4:1 /c "Packer Shutdown"
    communicator: winrm
    winrm_username: "{{ user `username` }}"
    winrm_password: "{{ user `password` }}"
    ssh_proxy_host: 127.0.0.1 # Local proxy in order to bypass VPN routing
    ssh_proxy_port: "{{ user `aquarium_bait_proxy_port` }}"
    ssh_proxy_username: "{{ user `username` }}"
    ssh_proxy_password: "{{ user `password` }}"
    winrm_timeout: 2m

provisioners:
  - type: ansible
    command: ./run_ansible.sh
    user: "{{ user `username` }}"
    playbook_file: playbooks/visualstudio_image.yml
    use_proxy: false # For proper connection with VMWare
    ansible_env_vars: # To fight the MacOS winrm python crash
      - no_proxy="*"  # https://www.packer.io/docs/provisioners/ansible/ansible#method-1-recommended
    extra_arguments:
      - -e
      - ansible_password={{ user `password` }}
      - -e
      - 'visualstudio_install_path="C:\Program Files (x86)\MSVS"'

post-processors:
  - type: shell-local # Use relative path in vmx and vmdk
    command: "empty"
    execute_command:
      - sed
      - -i.orig
      - -e
      - s|{{ user `out_full_path` }}|..|g
      - "{{ user `out_full_path` }}/{{ user `vm_name` }}/{{ user `vm_name` }}.vmx"
      - "{{ user `out_full_path` }}/{{ user `vm_name` }}/MainDisk-1-cl{{ user `aquarium_bait_stage` }}.vmdk"

  - type: shell-local # Create snapshot
    command: "empty"
    execute_command:
      - vmrun
      - snapshot
      - "{{ user `out_full_path` }}/{{ user `vm_name` }}/{{ user `vm_name` }}.vmx"
      - original
