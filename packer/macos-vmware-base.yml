---
min_packer_version: 1.6.6
variables:
  vm_name: macos-1015-base
  output_directory: out/macos-vmware-base
  vmx_path: "{{ env `PACKER_VMX_PATH` }}"
  cpu_number: "{{ env `PACKER_CPU_NUMBER` }}"
  username: admin
  password: admin
builders:
  - type: vmware-vmx
    vm_name: "{{ user `vm_name` }}"
    display_name: "{{ user `vm_name` }}"
    source_path: "{{ user `vmx_path` }}"
    linked: false # Create full copy to decrease the image size
    output_directory: "{{ user `output_directory` }}"
    headless: true
    boot_wait: 10s
    shutdown_command: "echo '{{ user `username` }}' | sudo -S shutdown -h now"
    ssh_username: "{{ user `username` }}"
    ssh_password: "{{ user `password` }}"
    ssh_timeout: 10s
    ssh_read_write_timeout: 10s
    ssh_wait_timeout: 2m
    tools_upload_flavor: darwin
    vmx_data:
      numvcpus: "{{ user `cpu_number` }}"
      cpuid.coresPerSocket: "{{ user `cpu_number` }}"
      sata0:1.filename: ""
      sata0:1.present: "FALSE" # Disable CD-Rom
provisioners:
  - type: ansible
    command: ./run_ansible.sh
    user: "{{ user `username` }}"
    playbook_file: playbooks/base_image.yml
    extra_arguments:
      - --extra-vars
      - ansible_sudo_pass={{ user `password` }}
